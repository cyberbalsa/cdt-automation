---
# ==============================================================================
# CREATE DOMAIN USERS AND GROUPS
# ==============================================================================
# This playbook creates user accounts and groups in Active Directory
#
# Students: Run this AFTER the domain controller is set up
#
# What it does:
# 1. Creates domain groups (IT Staff, Accounting, Engineering, etc.)
# 2. Creates domain user accounts with passwords
# 3. Assigns users to appropriate groups
# 4. Displays summary of created accounts
#
# Expected runtime: 2-3 minutes
#
# Usage:
#   ansible-playbook playbooks/create-domain-users.yml

- name: Create Active Directory Users and Groups
  hosts: windows_dc  # Run on the domain controller
  gather_facts: true

  pre_tasks:
    - name: Load global variables
      ansible.builtin.include_vars:
        file: "../group_vars/all.yml"

    - name: Load domain controller variables
      ansible.builtin.include_vars:
        file: "../group_vars/windows_dc.yml"

    - name: Display configuration
      ansible.builtin.debug:
        msg:
          - "==================================================="
          - "Creating domain users and groups"
          - "Domain: {{ domain_name }}"
          - "Users to create: {{ domain_users | length }}"
          - "Groups to create: {{ domain_groups | length }}"
          - "==================================================="

    - name: Verify AD services are running
      ansible.windows.win_service:
        name: ADWS  # Active Directory Web Services
        state: started
      register: adws_status
      ignore_errors: true
      when: not ansible_check_mode

  # Main tasks: Execute the domain_users role
  roles:
    - role: domain_users

  # Post-deployment tasks
  post_tasks:
    - name: Configure SSH access for domain users on Linux
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Domain Users Created Successfully!"
          - "=========================================="
          - ""
          - "Next steps:"
          - "1. These users can now log in to Windows machines"
          - "2. Run join-linux-domain.yml if you haven't already"
          - "3. Domain users can SSH to Linux machines after domain join"
          - ""
          - "Test Windows login (RDP):"
          - "  Username: CDT\\jdoe"
          - "  Password: UserPass123!"
          - ""
          - "Test Linux SSH login:"
          - "  ssh jdoe@<linux_ip>"
          - "  Password: UserPass123!"
          - ""
          - "Domain Admin account (high privilege):"
          - "  Username: CDT\\asmith"
          - "  Password: UserPass123!"
          - ""
          - "=========================================="

# ==============================================================================
# CUSTOMIZING USERS FOR STUDENTS
# ==============================================================================
#
# To add more users, edit: ansible/group_vars/all.yml
#
# Example - add a new user:
#
# domain_users:
#   - username: tstark
#     firstname: Tony
#     surname: Stark
#     password: IAmIronMan123!
#     groups:
#       - Domain Users
#       - Engineering
#       - Domain Admins  # Make them an admin
#
# Then re-run this playbook: ansible-playbook playbooks/create-domain-users.yml
#
# ==============================================================================
# PASSWORD POLICY MODIFICATION
# ==============================================================================
#
# Students: Want to practice password attacks? Configure weak password policy:
#
# On Domain Controller (PowerShell):
#   Set-ADDefaultDomainPasswordPolicy `
#     -Identity CDT.local `
#     -MinPasswordLength 1 `
#     -ComplexityEnabled $false `
#     -MaxPasswordAge 0
#
# WARNING: Only do this in isolated lab environments!
#
# ==============================================================================
