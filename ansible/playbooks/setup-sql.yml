---
# ===========================================================================
# SETUP SQL SERVER (MariaDB)
# ===========================================================================
# Installs and configures MariaDB with a scoring test database.
#
# Target hosts: [sql] inventory group
# Services: MySQL/MariaDB (3306)
# Authentication: Local users
# ===========================================================================

- name: Setup MariaDB SQL Server
  hosts: sql
  become: true
  gather_facts: true
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/services.yml

  tasks:
    # -------------------------------------------------------------------------
    # STEP 1: Install MariaDB
    # -------------------------------------------------------------------------
    - name: Install MariaDB server
      ansible.builtin.apt:
        name:
          - mariadb-server
          - python3-pymysql
        state: present
        update_cache: true

    # -------------------------------------------------------------------------
    # STEP 2: Configure MariaDB to bind to all interfaces
    # -------------------------------------------------------------------------
    - name: Configure MariaDB bind address
      ansible.builtin.lineinfile:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        regexp: '^bind-address'
        line: "bind-address = {{ sql_bind_address }}"
      notify: Restart MariaDB

    # -------------------------------------------------------------------------
    # STEP 3: Start and enable MariaDB
    # -------------------------------------------------------------------------
    - name: Enable and start MariaDB service
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: true

    # -------------------------------------------------------------------------
    # STEP 4: Create scoring test database
    # -------------------------------------------------------------------------
    - name: Create scoring test database
      community.mysql.mysql_db:
        name: "{{ sql_scoring_db }}"
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

    # -------------------------------------------------------------------------
    # STEP 5: Create scoring user with remote access
    # -------------------------------------------------------------------------
    - name: Create scoring user for remote access
      community.mysql.mysql_user:
        name: "{{ sql_scoring_user }}"
        password: "{{ sql_scoring_password }}"
        host: "%"
        priv: "{{ sql_scoring_db }}.*:ALL"
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

    - name: Create scoring user for localhost access
      community.mysql.mysql_user:
        name: "{{ sql_scoring_user }}"
        password: "{{ sql_scoring_password }}"
        host: "localhost"
        priv: "{{ sql_scoring_db }}.*:ALL"
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

    # -------------------------------------------------------------------------
    # STEP 6: Create test table with data
    # -------------------------------------------------------------------------
    - name: Create test table
      community.mysql.mysql_query:
        login_unix_socket: /run/mysqld/mysqld.sock
        login_db: "{{ sql_scoring_db }}"
        query:
          - CREATE TABLE IF NOT EXISTS scoring_status (id INT PRIMARY KEY, status VARCHAR(50), updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
          - INSERT INTO scoring_status (id, status) VALUES (1, 'operational') ON DUPLICATE KEY UPDATE status='operational'

  handlers:
    - name: Restart MariaDB
      ansible.builtin.service:
        name: mariadb
        state: restarted
