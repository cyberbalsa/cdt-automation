# {{ ansible_managed }}
# DWAYNE-INATOR-5000 Configuration
# Generated from Ansible variables - do not edit manually

# ==============================================================================
# EVENT SETTINGS
# ==============================================================================
event = "{{ scoring_event_name }}"
verbose = {{ scoring_verbose | lower }}
timezone = "{{ scoring_timezone }}"
port = {{ scoring_port }}
startpaused = {{ scoring_start_paused | lower }}

# ==============================================================================
# TIMING SETTINGS
# ==============================================================================
delay = {{ scoring_delay }}
jitter = {{ scoring_jitter }}
timeout = {{ scoring_timeout }}
servicepoints = {{ scoring_service_points }}
slathreshold = {{ scoring_sla_threshold }}
slapoints = {{ scoring_sla_points }}

# ==============================================================================
# ADMIN ACCOUNTS
# ==============================================================================
{% for admin in scoring_admins %}
[[admin]]
name = "{{ admin.name }}"
pw = "{{ admin.password }}"

{% endfor %}
# ==============================================================================
# TEAMS
# ==============================================================================
{% for team in scoring_teams %}
[[team]]
ip = "{{ team.id }}"
pw = "{{ team.password }}"

{% endfor %}
# ==============================================================================
# CREDENTIAL LISTS
# ==============================================================================
{% for cred in scoring_credlists %}
[[creds]]
name = "{{ cred.name }}"
usernames = [{% for user in cred.usernames %}"{{ user }}"{% if not loop.last %}, {% endif %}{% endfor %}]
defaultpw = "{{ cred.default_password }}"

{% endfor %}
# ==============================================================================
# BOX CONFIGURATIONS (Auto-generated from service_hosts)
# ==============================================================================
# Boxes are generated from OpenTofu service_hosts variable.
# Default checks come from group_vars/scoring_services.yml
# Custom overrides come from group_vars/scoring_overrides.yml
#
# To add a service to a box:
# 1. Edit opentofu/variables.tf -> service_hosts
# 2. Run: tofu apply && python3 import-tofu-to-ansible.py
# 3. Run: ansible-playbook playbooks/setup-scoring-engine.yml

{% set scored_hosts = [] %}
{% for host in groups['blue_team'] | default([]) %}
{% if hostvars[host]['host_services'] is defined %}
{% set _ = scored_hosts.append(host) %}
{% endif %}
{% endfor %}

{% for hostname in scored_hosts %}
{% set host_services = hostvars[hostname]['host_services'] | from_json if hostvars[hostname]['host_services'] is string else hostvars[hostname]['host_services'] %}
{% set box_overrides = scoring_box_overrides.get(hostname, {}) if scoring_box_overrides is defined else {} %}
[[box]]
name = "{{ hostname }}"
ip = "{{ hostvars[hostname]['internal_ip'] }}"

{% for service in host_services %}
{% if service in box_overrides %}
{# Use override checks for this service #}
{% for check in box_overrides[service] %}
    [[box.{{ check.type }}]]
{% if check.display is defined %}
    display = "{{ check.display }}"
{% endif %}
{% if check.credlists is defined %}
    credlists = [{% for cl in check.credlists %}"{{ cl }}"{% if not loop.last %}, {% endif %}{% endfor %}]
{% endif %}
{% if check.port is defined %}
    port = {{ check.port }}
{% endif %}
{% if check.count is defined %}
    count = {{ check.count }}
{% endif %}
{% if check.allowpacketloss is defined %}
    allowpacketloss = {{ check.allowpacketloss | lower }}
{% endif %}
{% if check.percent is defined %}
    percent = {{ check.percent }}
{% endif %}
{% if check.encrypted is defined %}
    encrypted = {{ check.encrypted | lower }}
{% endif %}
{% if check.anonymous is defined %}
    anonymous = {{ check.anonymous | lower }}
{% endif %}
{% if check.sender is defined %}
    sender = "{{ check.sender }}"
{% endif %}
{% if check.receiver is defined %}
    receiver = "{{ check.receiver }}"
{% endif %}
{% if check.body is defined %}
    body = "{{ check.body }}"
{% endif %}
{% if check.records is defined %}
{% for record in check.records %}
        [[box.dns.record]]
        kind = "{{ record.kind }}"
        domain = "{{ record.domain }}"
        answer = [{% for ans in record.answer %}"{{ ans }}"{% if not loop.last %}, {% endif %}{% endfor %}]

{% endfor %}
{% endif %}
{% if check.urls is defined %}
{% for url in check.urls %}
        [[box.web.url]]
{% if url.path is defined %}
        path = "{{ url.path }}"
{% endif %}
{% if url.status is defined %}
        status = {{ url.status }}
{% endif %}
{% if url.regex is defined %}
        regex = "{{ url.regex }}"
{% endif %}

{% endfor %}
{% endif %}
{% if check.commands is defined %}
{% for cmd in check.commands %}
        [[box.{{ check.type }}.command]]
        command = '{{ cmd.command }}'
{% if cmd.output is defined %}
        output = "{{ cmd.output }}"
{% endif %}
{% if cmd.contains is defined %}
        contains = {{ cmd.contains | lower }}
{% endif %}
{% if cmd.useregex is defined %}
        useregex = {{ cmd.useregex | lower }}
{% endif %}

{% endfor %}
{% endif %}
{% if check.queries is defined %}
{% for query in check.queries %}
        [[box.sql.query]]
{% if query.database is defined %}
        database = "{{ query.database }}"
{% endif %}
{% if query.table is defined %}
        table = "{{ query.table }}"
{% endif %}
{% if query.column is defined %}
        column = "{{ query.column }}"
{% endif %}
{% if query.output is defined %}
        output = "{{ query.output }}"
{% endif %}
{% if query.contains is defined %}
        contains = {{ query.contains | lower }}
{% endif %}
{% if query.databaseexists is defined %}
        databaseexists = {{ query.databaseexists | lower }}
{% endif %}

{% endfor %}
{% endif %}
{% if check.domain is defined %}
    domain = "{{ check.domain }}"
{% endif %}
{% if check.share is defined %}
    share = "{{ check.share }}"
{% endif %}
{% if check.files is defined %}
{% for file in check.files %}
        [[box.{{ check.type }}.file]]
        name = '{{ file.name }}'
{% if file.hash is defined %}
        hash = "{{ file.hash }}"
{% endif %}
{% if file.regex is defined %}
        regex = "{{ file.regex }}"
{% endif %}

{% endfor %}
{% endif %}

{% endfor %}
{% elif service_check_defaults is defined and service in service_check_defaults %}
{# Use default checks for this service #}
{% for check in service_check_defaults[service] %}
    [[box.{{ check.type }}]]
{% if check.display is defined %}
    display = "{{ check.display }}"
{% endif %}
{% if check.credlists is defined %}
    credlists = [{% for cl in check.credlists %}"{{ cl }}"{% if not loop.last %}, {% endif %}{% endfor %}]
{% endif %}
{% if check.port is defined %}
    port = {{ check.port }}
{% endif %}
{% if check.count is defined %}
    count = {{ check.count }}
{% endif %}
{% if check.allowpacketloss is defined %}
    allowpacketloss = {{ check.allowpacketloss | lower }}
{% endif %}
{% if check.percent is defined %}
    percent = {{ check.percent }}
{% endif %}
{% if check.encrypted is defined %}
    encrypted = {{ check.encrypted | lower }}
{% endif %}
{% if check.anonymous is defined %}
    anonymous = {{ check.anonymous | lower }}
{% endif %}
{% if check.sender is defined %}
    sender = "{{ check.sender }}"
{% endif %}
{% if check.receiver is defined %}
    receiver = "{{ check.receiver }}"
{% endif %}
{% if check.body is defined %}
    body = "{{ check.body }}"
{% endif %}
{% if check.urls is defined %}
{% for url in check.urls %}
        [[box.web.url]]
{% if url.path is defined %}
        path = "{{ url.path }}"
{% endif %}
{% if url.status is defined %}
        status = {{ url.status }}
{% endif %}
{% if url.regex is defined %}
        regex = "{{ url.regex }}"
{% endif %}

{% endfor %}
{% endif %}
{% if check.queries is defined %}
{% for query in check.queries %}
        [[box.sql.query]]
{% if query.database is defined %}
        database = "{{ query.database }}"
{% endif %}
{% if query.databaseexists is defined %}
        databaseexists = {{ query.databaseexists | lower }}
{% endif %}

{% endfor %}
{% endif %}

{% endfor %}
{% endif %}
{% endfor %}
{# Append extra_checks if defined #}
{% if box_overrides.extra_checks is defined %}
{% for check in box_overrides.extra_checks %}
    [[box.{{ check.type }}]]
{% if check.display is defined %}
    display = "{{ check.display }}"
{% endif %}
{% if check.credlists is defined %}
    credlists = [{% for cl in check.credlists %}"{{ cl }}"{% if not loop.last %}, {% endif %}{% endfor %}]
{% endif %}
{% if check.port is defined %}
    port = {{ check.port }}
{% endif %}
{% if check.commands is defined %}
{% for cmd in check.commands %}
        [[box.{{ check.type }}.command]]
        command = '{{ cmd.command }}'
{% if cmd.output is defined %}
        output = "{{ cmd.output }}"
{% endif %}
{% if cmd.contains is defined %}
        contains = {{ cmd.contains | lower }}
{% endif %}
{% if cmd.useregex is defined %}
        useregex = {{ cmd.useregex | lower }}
{% endif %}

{% endfor %}
{% endif %}

{% endfor %}
{% endif %}
{% endfor %}
